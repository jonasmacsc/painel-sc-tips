<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<section class="card" id="strategiesSection">
  <h3>
    ğŸ¯ EstratÃ©gias Live â€” <span id="strCount">Ativas: 0/24</span>
  </h3>
  <div class="row" style="margin-bottom:8px">
    <button class="btn small" id="btnAll">âœ… Todas</button>
    <button class="btn small dark" id="btnBest">ğŸ¯ Ã“timas</button>
    <button class="btn small dark" id="btnNone">âŒ Limpar</button>
  </div>
  <div class="list" id="strList"></div>
  <div class="tip">Gatilho + NÃºmeros-base visÃ­veis; vizinhos ficam no operador. ğŸ´ incluÃ­do nos Cavalos.</div>
</section>
  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<title>âš¡ FASCOR â€¢ Matrix Premium â€” SC TIPS</title>
<meta name="theme-color" content="#0b0a05">
<link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16.png">
<link rel="manifest" href="assets/favicon/site.webmanifest">
<style>
  :root{
    /* FASCOR â€¢ Gold Neon */
    --bg:#070804; --panel:#0b0f08; --panel2:#0e130b; --stroke:#2a2b1a;
    --ink:#f8ffe9; --muted:#d8e9a0;
    --gold:#f7d253; --gold-deep:#c2972a; --gold-neon:#fff06a;
    --glow:0 0 10px rgba(255,240,106,.45),0 0 24px rgba(247,210,83,.35);
    --glow-strong:0 0 14px rgba(255,240,106,.7),0 0 36px rgba(247,210,83,.6);
    --ok:#2ad17f; --err:#ff6464; --warn:#ffd24d;
    --chip-green:#00d37e; --chip-red:#ff5a5a; --chip-black:#6fe0ff;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{background:var(--bg);color:var(--ink);font:16px/1.5 Inter,Segoe UI,system-ui,sans-serif}

  /* NAVBAR */
  nav{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(15,17,10,.9),rgba(10,11,6,.9));border-bottom:1px solid #3a361c;box-shadow:var(--glow)}
  nav .row{display:flex;align-items:center;justify-content:space-between;padding:12px 18px}
  .brand{display:flex;align-items:center;gap:10px;text-shadow:var(--glow)}
  .brand video,.brand img{width:42px;height:42px;border-radius:10px;object-fit:cover;background:#000;box-shadow:var(--glow)}
  .brand b{font-weight:900;letter-spacing:.3px;color:var(--gold-neon)}
  .brand small{border:1px solid #3a361c;padding:2px 8px;border-radius:999px;color:#13140a;background:#0b0d07}
  .menu{display:flex;gap:8px;flex-wrap:wrap}
  .menu a{padding:8px 14px;border-radius:10px;color:#eee9c9;border:1px solid #3a361c;background:#0b0d07}
  .menu a:hover{box-shadow:var(--glow)}
  .menu a.active{background:linear-gradient(135deg,var(--gold-neon),var(--gold));color:#161305;font-weight:800;border:0;box-shadow:var(--glow-strong)}

  .wrap{max-width:1240px;margin:0 auto;padding:18px}
  h1{font-size:30px;margin:14px 0 10px;font-weight:900;color:var(--gold-neon);text-shadow:var(--glow)}
  h2{font-size:18px;margin:8px 0 12px;color:var(--muted);font-weight:700}
  h3{margin:14px 0 10px;font-weight:800;color:var(--gold);text-shadow:var(--glow)}

  .grid{display:grid;gap:16px}
  @media(min-width:960px){.grid{grid-template-columns:1.2fr 1fr 1fr}}

  .card{background:linear-gradient(180deg,#0f1209,#0b0f08);border:1px solid #3a361c;padding:14px;border-radius:16px;box-shadow:inset 0 0 0 1px rgba(255,240,106,.08),var(--glow)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

  /* BotÃµes dourados */
  .btn{padding:10px 14px;border-radius:12px;cursor:pointer;color:#13120a;border:0;font-weight:800;letter-spacing:.3px;background:linear-gradient(180deg,var(--gold-neon),var(--gold));box-shadow:var(--glow)}
  .btn:hover{filter:brightness(1.05);box-shadow:var(--glow-strong)}
  .btn.ghost{color:#efeacd;background:#0b0d07;border:1px solid #3a361c;box-shadow:var(--glow)}
  .btn.small{padding:6px 10px;font-size:14px}
  .btn.dark{color:#efeacd;background:#121406;border:1px solid #3a361c}

  .console{background:#0a0d07;border:1px solid #3a361c;padding:12px;border-radius:16px;margin:16px 0;box-shadow:var(--glow)}
  .loglist{background:#0a0c06;border:1px solid #2d2a15;border-radius:12px;height:240px;overflow:auto;padding:8px}
  .log{margin:6px 0;padding:8px 10px;border-radius:10px;font-size:14px}
  .hit{background:rgba(42,209,127,.08);border:1px solid #2ad17f}
  .miss{background:rgba(255,100,100,.08);border:1px solid #ff6464}
  .sys{background:rgba(255,240,106,.06);border:1px solid #7a6b1b}
  .warn{background:rgba(255,210,77,.08);border:1px solid #b4931f}

  input[type="text"],input[type="number"],input[type="url"]{background:#0b0d07;border:1px solid #3a361c;color:#efeacd;border-radius:12px;padding:10px 12px;outline:none;min-width:180px;box-shadow:var(--glow)}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#0b0d07;border:1px solid #3a361c;padding:6px 10px;border-radius:999px;color:#efeacd}
  .stat{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid #3a361c;border-radius:999px;background:#0b0d07;box-shadow:var(--glow)}
  .stat b{color:var(--gold-neon)}

  /* Ãšltimos nÃºmeros chips */
  .lastbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 2px}
  .chip{min-width:38px;height:38px;display:flex;align-items:center;justify-content:center;border-radius:12px;font-weight:900;border:2px solid #1a1a10;box-shadow:var(--glow)}
  .chip.green{background:rgba(0,211,126,.18);border-color:var(--chip-green);color:#ccffe9}
  .chip.red{background:rgba(255,90,90,.18);border-color:var(--chip-red);color:#ffecec}
  .chip.black{background:rgba(111,224,255,.12);border-color:var(--chip-black);color:#eaffff}

  /* Toggles */
  .toggle{appearance:none;width:46px;height:26px;border-radius:999px;background:#23240f;position:relative;cursor:pointer;outline:none;border:1px solid #3a361c;box-shadow:var(--glow)}
  .toggle:checked{background:linear-gradient(180deg,var(--gold-neon),var(--gold))}
  .toggle:before{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;background:#111;border-radius:50%;transition:.18s;box-shadow:0 0 6px rgba(0,0,0,.6)}
  .toggle:checked:before{left:23px;background:#1a1506}

  /* Plataformas */
  .plat{background:#121407;border:1px solid #3a361c;border-radius:14px;padding:10px;box-shadow:var(--glow)}
  .plat h4{display:flex;align-items:center;gap:8px;color:var(--gold-neon);text-shadow:var(--glow);font-weight:900}
  .lat{background:#0b0d07;border:1px solid #3a361c;border-radius:999px;padding:2px 8px;font-size:12px;color:#efeacd}
  canvas.spark{display:block;width:150px;height:40px}

  footer{margin:28px 0 12px;text-align:center;color:#c9c29b;font-size:13px}
  .hr{height:1px;background:linear-gradient(90deg,transparent,#423b1b,transparent);margin:12px 0}
  .tip{font-size:12px;color:#d6ce98}
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="row">
    <a class="brand" href="index.html" title="SC TIPS â€¢ Home">
      <video src="assets/media/logo-animated.mp4" autoplay muted loop playsinline poster="assets/img/branding/logo-static.png"></video>
      <span><b>SC TIPS</b><small>FASCOR â€¢ VIP</small></span>
    </a>
    <div class="menu">
      <a href="index.html">Home</a>
      <a href="estrategias.html">EstratÃ©gias</a>
      <a class="active" href="matrix-premium.html">Matrix Premium</a>
      <a href="puxadores.html">Puxadores Live</a>
      <a href="contato.html">Contato</a>
    </div>
  </div>
</nav>

<div class="wrap">
  <h1>âš¡ Matrix Premium â€” Tema FASCOR (Gold Neon)</h1>

  <!-- CONSOLE -->
  <section class="console" role="region" aria-label="Console e Logs">
    <h3>ğŸ–¥ï¸ Console Matrix</h3>
    <div class="row">
      <button class="btn dark" id="btnClear">ğŸ§¹ Limpar</button>
      <button class="btn dark" id="btnExport">ğŸ“„ Exportar TXT</button>
      <button class="btn dark" id="btnCSV">ğŸ“Š Exportar CSV</button>
      <button class="btn ghost" id="btnSounds">ğŸ”Š Sons: <span id="sndState">off</span></button>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="logFilter" type="text" placeholder="ğŸ” Pesquisar logs (dealer, nÂº, Pragmatic/Evolution)">
      <span class="pill"><input type="checkbox" id="flt-sys" checked> SYS</span>
      <span class="pill"><input type="checkbox" id="flt-hit" checked> HIT</span>
      <span class="pill"><input type="checkbox" id="flt-miss" checked> MISS</span>
    </div>
    <div class="loglist" id="loglist"></div>
  </section>

  <!-- STATUS + Ãšltimos NÃºmeros + ConexÃ£o -->
  <section class="card">
    <h3>ğŸ“¡ Status do Motor & ConexÃ£o</h3>
    <div class="row" style="margin-bottom:8px">
      <span class="stat">CadÃªncia: <b id="cadence">18s</b></span>
      <span class="stat">Contagem: <b id="countdown">â€”</b></span>
      <span class="stat">Ãšltima: <b id="last">--</b></span>
      <span class="stat">Rodadas: <b id="rounds">0</b></span>
      <span class="stat">WS: <b id="wsstat">offline</b></span>
      <span class="stat">Tips Matrix â€¢ <b id="platChip">Engine</b></span>
    </div>

    <h2>ğŸ”¢ Ãšltimos nÃºmeros</h2>
    <div class="lastbar" id="lastbar"></div>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="btnStart">â–¶ï¸ Iniciar</button>
      <button class="btn dark" id="btnPause">â¸ï¸ Pausar</button>
      <button class="btn dark" id="btnReset">ğŸ” Reset</button>
      <input id="cadInput" type="number" min="5" max="60" step="1" value="18" title="CadÃªncia (s)">
      <button class="btn small" id="btnCad">â±ï¸ Aplicar</button>
    </div>

    <div class="hr"></div>

    <h2>ConexÃ£o (WS/API)</h2>
    <div class="row">
      <input id="apiUrl" type="url" placeholder="Cole aqui a URL do WebSocket/API (Evolution/Pragmatic)">
      <button class="btn small dark" id="btnMask">ğŸ™ˆ Mascarar</button>
      <button class="btn small dark" id="btnCopy">ğŸ“‹ Copiar</button>
      <button class="btn small" id="btnConnect">ğŸ”Œ Conectar</button>
      <button class="btn small dark" id="btnDisconnect" disabled>âŒ Desconectar</button>
      <input id="simNumber" type="number" min="0" max="36" placeholder="Simular nÂº (0-36)">
      <button class="btn small" id="btnSim">ğŸ¯ Simular</button>
    </div>
    <div class="tip" style="margin-top:6px">Tokens da URL sÃ£o ocultos nos logs. BroadcastChannel e postMessage ativos.</div>
  </section>

  <!-- ENTRADAS AUTOMÃTICAS -->
  <section class="card">
    <h3>âš¡ Entradas AutomÃ¡ticas</h3>
    <div class="row" style="margin-top:6px">
      <button class="btn" id="btnGenerate">âš¡ Gerar Entradas</button>
      <button class="btn" id="btnAuto">ğŸ¤– Auto-On: <span id="autoState">OFF</span></button>
    </div>
    <div class="tip" style="margin-top:6px">â€œGerar Entradasâ€ ativa as melhores e a <b>ğŸ¬ Exclusiva do VÃ­deo</b>. Com Auto-On ligado, dispara a cada batida do motor.</div>
  </section>

  <div class="grid">
    <!-- PLATAFORMAS -->
    <section class="card">
      <h3>ğŸ² Plataformas Matrix</h3>
      <div class="row" id="platforms"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnExportCsv">ğŸ“Š Exportar CSV</button>
        <button class="btn dark" id="btnClearNums">ğŸ§¹ Limpar nÃºmeros</button>
        <button class="btn small" id="btnPing">ğŸ“¡ Broadcast Ping</button>
      </div>
      <div class="tip">Evolution/Pragmatic linkados via WebSocket; BC e postMessage integrados.</div>
    </section>

    <!-- EstratÃ©gias -->
    <section class="card">
      <h3>ğŸ¯ EstratÃ©gias Live â€” 23 + ğŸ¬ Exclusiva</h3>
      <div class="row" style="margin-bottom:8px">
        <button class="btn small" id="btnAll">âœ… Todas</button>
        <button class="btn small dark" id="btnBest">ğŸ¯ Ã“timas</button>
        <button class="btn small dark" id="btnNone">âŒ Limpar</button>
      </div>
      <div class="list" id="strList"></div>
      <div class="tip">Mostra apenas <b>nÃºmeros-base</b> e <b>gatilho</b> (vizinho Ã© no operador). ğŸ´ nos Cavalos.</div>
    </section>

    <!-- System -->
    <section class="card">
      <h3>ğŸ§° Tips Matrix / System</h3>
      <p class="tip">Canal: <b>matrix-channel</b> â€¢ postMessage <b>on</b> â€¢ handlers ativos.</p>
    </section>
  </div>
</div>

<footer>Â© 2025 <b>SC TIPS</b> â€” Tema FASCOR Gold Neon.</footer>

<!-- AUDIO -->
<audio id="snd-green" src="assets/audio/green.mp3" preload="auto"></audio>
<audio id="snd-red"   src="assets/audio/red.mp3"   preload="auto"></audio>
<audio id="snd-alert" src="assets/audio/alerta.mp3" preload="auto"></audio>
<audio id="snd-click" src="assets/audio/click.mp3"  preload="auto"></audio>

<script>
/* ===== Helpers & Logs ===== */
const $ = s => document.querySelector(s);
const loglist = $("#loglist");
const filters = { sys:true, hit:true, miss:true, text:"" };
function capLogs(max=800){ while(loglist.children.length>max){ loglist.removeChild(loglist.firstChild); } }
function log(msg, cls="sys"){
  if(cls!=="warn" && !filters[cls]) return;
  if(filters.text && !String(msg).toLowerCase().includes(filters.text)) return;
  const d=document.createElement("div");
  d.className="log "+cls;
  d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
  loglist.appendChild(d); loglist.scrollTop=loglist.scrollHeight; capLogs();
}
$("#btnClear").onclick=()=>loglist.innerHTML="";
$("#btnExport").onclick=()=>{ const txt=[...loglist.children].map(x=>x.textContent).join("\n"); const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([txt],{type:"text/plain"})); a.download="matrix_logs.txt"; a.click(); URL.revokeObjectURL(a.href); };
$("#btnCSV").onclick=()=>exportCSV();
$("#flt-sys").onchange=e=>filters.sys=e.target.checked;
$("#flt-hit").onchange=e=>filters.hit=e.target.checked;
$("#flt-miss").onchange=e=>filters.miss=e.target.checked;
$("#logFilter").oninput=e=>filters.text=(e.target.value||"").toLowerCase();

/* ===== Sons ===== */
let soundsOn=false; const sndState=$("#sndState");
$("#btnSounds").onclick=()=>{ soundsOn=!soundsOn; sndState.textContent=soundsOn?"on":"off"; try{$("#snd-click").play().catch(()=>{});}catch(e){} };
function play(id){ if(!soundsOn) return; const el=document.getElementById(id); if(el){ el.currentTime=0; el.play().catch(()=>{});} }

/* ===== Ãšltimos nÃºmeros (chips) ===== */
const lastbar = $("#lastbar");
const redSet = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
function colorOf(n){ return n===0?"green":(redSet.has(n)?"red":"black"); }
let recent = []; // mÃ¡x 16
function pushNumber(n){ recent.unshift(n); if(recent.length>16) recent.pop(); renderChips(); }
function renderChips(){ lastbar.innerHTML=""; recent.forEach(n=>{ const c=document.createElement("div"); c.className="chip "+colorOf(n); c.textContent=n; c.title="Repetir "+n; c.onclick=()=>handleIncoming({number:n, source:"chip"}); lastbar.appendChild(c); }); }

/* ===== Motor 18s (anti-drift) ===== */
let cadence=18, running=false, rounds=0, nextBeat=0, tickHandle=null;
const elCad=$("#cadence"), elCount=$("#countdown"), elRounds=$("#rounds"), elLast=$("#last"), elWS=$("#wsstat");
function scheduleNext(){ const now=performance.now(); const wait=Math.max(0,nextBeat-now); tickHandle=setTimeout(onBeat, wait); }
function onBeat(){ rounds++; elRounds.textContent=String(rounds); nextBeat+=cadence*1000; log("â±ï¸ Tick (nova rodada)","sys"); play("snd-alert"); if(autoOn) sendEntries("auto-on"); updateCountdown(); scheduleNext(); }
function updateCountdown(){ if(!running){ elCount.textContent="â€”"; return; } const now=performance.now(); const rem=Math.max(0,(nextBeat-now)/1000); elCount.textContent=`${rem.toFixed(1)}s`; requestAnimationFrame(updateCountdown); }
function startMotor(){ if(running) return; running=true; const now=performance.now(); nextBeat=now+cadence*1000; log(`Motor iniciado (cadÃªncia ${cadence}s)`,"sys"); play("snd-click"); scheduleNext(); updateCountdown(); }
function pauseMotor(){ if(!running) return; running=false; clearTimeout(tickHandle); tickHandle=null; log("Motor pausado","sys"); }
function resetMotor(){ pauseMotor(); rounds=0; elRounds.textContent="0"; elCount.textContent="â€”"; log("Reset aplicado","sys"); }
$("#btnStart").onclick=startMotor; $("#btnPause").onclick=pauseMotor; $("#btnReset").onclick=resetMotor;
$("#btnCad").onclick=()=>{ const v=parseInt($("#cadInput").value,10); if(Number.isFinite(v)&&v>=5&&v<=60){ cadence=v; elCad.textContent=`${v}s`; if(running){ pauseMotor(); startMotor(); } log(`CadÃªncia ajustada para ${v}s`,"sys"); } else { log("Valor invÃ¡lido para cadÃªncia (5â€“60)","warn"); } };
document.addEventListener("visibilitychange",()=>{ if(document.hidden && running){ pauseMotor(); log("Aba oculta: motor pausado (higiene)","warn"); }});

/* ===== Plataformas + mini grÃ¡fico ===== */
const plats=[{name:"Evolution",icon:"ğŸ¡"},{name:"Pragmatic",icon:"ğŸ°"},{name:"Donald",icon:"ğŸ²"},{name:"BBTips",icon:"ğŸ“ˆ"},{name:"Lucky",icon:"ğŸ€"},{name:"Engine",icon:"ğŸ§ "}];
const platBox=$("#platforms"); let activePlatform=localStorage.getItem("mp_active_platform")||"Engine"; $("#platChip").textContent=activePlatform;
function renderPlatforms(){
  platBox.innerHTML="";
  plats.forEach(p=>{
    const wrap=document.createElement("div");
    wrap.className="plat";
    wrap.innerHTML=`<h4>${p.icon} ${p.name} <span class="lat" id="lat_${p.name}">â€”ms</span></h4><canvas class="spark" id="sp_${p.name}" width="150" height="40"></canvas>`;
    wrap.onclick=()=>{ activePlatform=p.name; localStorage.setItem("mp_active_platform",activePlatform); $("#platChip").textContent=activePlatform; log("Plataforma ativa: "+activePlatform,"sys"); };
    platBox.appendChild(wrap);
  });
}
renderPlatforms();
const sparkData={}; plats.forEach(p=>sparkData[p.name]=[]);
function pushSpark(name,v){ const arr=sparkData[name]; arr.push(v); if(arr.length>30) arr.shift(); const cv=$("#sp_"+name), ctx=cv.getContext("2d"); ctx.clearRect(0,0,cv.width,cv.height); ctx.beginPath(); ctx.moveTo(0,cv.height-(arr[0]||0)); arr.forEach((val,i)=>{ ctx.lineTo(i*5, cv.height - val); }); ctx.strokeStyle="#38ff8b"; ctx.lineWidth=2; ctx.stroke(); }
/* fake ping visual */
setInterval(()=>{ plats.forEach(p=>{ const v=6+Math.floor(Math.random()*20); $("#lat_"+p.name).textContent=v+"ms"; pushSpark(p.name, Math.min(38,v)); }); }, 1200);

/* ===== EstratÃ©gias (23 + Exclusiva) ===== */
const STRATS = [
  { name:"ğŸ¬ Exclusiva do VÃ­deo", gatilho:"Ativa pelo vÃ­deo", base:[], forceDefault:true },
  { name:"Elite 2X",            gatilho:"Terminal 4 ou 5", base:[2,12,22,32] },
  { name:"Quarta DimensÃ£o",     gatilho:"Terminal 1 ou 3", base:[4,14,24,34] },
  { name:"FÃ³rmula 5X",          gatilho:"Terminal 6 ou 8", base:[5,15,25,35] },
  { name:"Alpha 6",             gatilho:"Terminal 2 ou 9", base:[6,16,26,36] },
  { name:"Coluna de Ouro",      gatilho:"â€” definir",       base:[] },
  { name:"TriÃ¢ngulo Vermelho",  gatilho:"â€” definir",       base:[] },
  { name:"PadrÃ£o Black",        gatilho:"13/31/33 recentes", base:[13,31,33] },
  { name:"Coluna de Prata",     gatilho:"â€” definir",       base:[] },
  { name:"Linha dos Finais 6",  gatilho:"â€” definir",       base:[6,16,26,36] },
  { name:"Tiro Seco SC",        gatilho:"Gatilho Tiro Seco", base:[] },
  { name:"ğŸ´ Cavalo SC Premium", gatilho:"Grupo quente 3+ ocorrÃªncias", base:[] },
  { name:"ğŸ´ Cavalos 258",      gatilho:"Grupo 258 aquecendo", base:[2,5,8,12,15,18,22,25,28] },
  { name:"MÃºltiplos de 3",      gatilho:"â€” definir",       base:[3,6,9,12,15,18,21,24,27,30,33,36] },
  { name:"Diagonais da Roda",   gatilho:"â€” definir",       base:[] },
  { name:"SequÃªncia 10+4",      gatilho:"â€” definir",       base:[] },
  { name:"Duplas SimÃ©tricas",   gatilho:"â€” definir",       base:[] },
  { name:"Trinca Ãmpares",      gatilho:"â€” definir",       base:[1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35] },
  { name:"Trinca Pares",        gatilho:"â€” definir",       base:[2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36] },
  { name:"ProteÃ§Ã£o Zero",       gatilho:"AusÃªncia longa de 0", base:[0] },
  { name:"Reverso Recentes",    gatilho:"Quebra de repetiÃ§Ã£o", base:[] },
  { name:"Gap Longo",           gatilho:"AusÃªncia 15+ rodadas", base:[] },
  { name:"Espiral da Roda",     gatilho:"â€” definir",       base:[] },
  { name:"Terminais 0/5",       gatilho:"Terminais 0 ou 5", base:[0,5,10,15,20,25,30,35] }
];
const strList=$("#strList"); const LS_KEY="mp_strats_enabled_fascor_v2";
function loadStr(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||"{}");}catch(_){return{}} }
function saveStr(s){ localStorage.setItem(LS_KEY,JSON.stringify(s||{})); }
const st=loadStr();
function copy(text){ navigator.clipboard.writeText(text).then(()=>log("Copiado: "+text,"sys")); }

function renderStr(){
  strList.innerHTML="";
  STRATS.forEach((s,i)=>{
    const id=`s_${i}`;
    const baseTxt = s.base.length ? s.base.join(", ") : "â€”";
    const div=document.createElement("div");
    div.className="row"; div.style="justify-content:space-between;align-items:center;border:1px solid #3a361c;background:#0b0d07;border-radius:14px;padding:10px;box-shadow:var(--glow)";
    div.title = `${s.name}\nGatilho: ${s.gatilho}\nBase: ${baseTxt}`;
    div.innerHTML=`
      <div style="display:flex;flex-direction:column;gap:4px">
        <b style="color:var(--gold-neon);text-shadow:var(--glow)">${s.name}</b>
        <span class="tip">Gatilho: ${s.gatilho} â€¢ Base: ${baseTxt}</span>
      </div>
      <div class="row">
        <button class="btn small dark" ${s.base.length? "":"disabled"} data-copy="${baseTxt}">ğŸ“‹ Copiar</button>
        <input id="${id}" type="checkbox" class="toggle">
      </div>
    `;
    strList.appendChild(div);
    const cb=div.querySelector("input");
    cb.checked = (st[s.name] ?? (s.forceDefault ? true : (i<9 ? true : false))); // Exclusiva do VÃ­deo ON por padrÃ£o
    cb.onchange=()=>{ st[s.name]=cb.checked; saveStr(st); log(`${s.name}: ${cb.checked?"ON":"OFF"}`,"sys"); play("snd-click"); };
    const btn=div.querySelector("[data-copy]"); if(btn) btn.onclick=()=>copy(btn.getAttribute("data-copy"));
    // persist
    st[s.name]=cb.checked;
  });
  saveStr(st);
}
renderStr();

/* SeleÃ§Ã£o em massa */
const BEST_SET = ["ğŸ¬ Exclusiva do VÃ­deo","Elite 2X","Quarta DimensÃ£o","FÃ³rmula 5X","ğŸ´ Cavalo SC Premium","Terminais 0/5"];
$("#btnAll").onclick=()=>{ STRATS.forEach(s=>st[s.name]=true); saveStr(st); renderStr(); log("âœ… Todas ON","sys"); };
$("#btnBest").onclick=()=>{ STRATS.forEach(s=>st[s.name]=BEST_SET.includes(s.name)); saveStr(st); renderStr(); log("ğŸ¯ Ativadas somente as Ã“timas","sys"); };
$("#btnNone").onclick=()=>{ STRATS.forEach(s=>st[s.name]=false); saveStr(st); renderStr(); log("âŒ Todas OFF","sys"); };

/* ===== Entradas AutomÃ¡ticas ===== */
let autoOn=false; const autoState=$("#autoState");
function activeStrategies(){ return STRATS.filter(s=>st[s.name]); }
function sendEntries(origin="manual"){
  const act = activeStrategies();
  const payload = {
    type:"entries",
    origin,
    at:Date.now(),
    platform:activePlatform,
    strategies: act.map(s=>s.name),
    base: Object.fromEntries(act.map(s=>[s.name, s.base])),
    last: recent.slice(0,10)
  };
  // Broadcast pra outros painÃ©is e log
  bc.postMessage(payload);
  log(`âš¡ ENTRADAS (${origin}) â€¢ ${act.length} estratÃ©gias â€¢ ${activePlatform}`, "sys");
  play("snd-alert");
}
$("#btnGenerate").onclick=()=>{ // ativa BEST + Exclusiva e dispara
  STRATS.forEach(s=>st[s.name]=BEST_SET.includes(s.name));
  saveStr(st); renderStr(); sendEntries("gerar-entradas");
};
$("#btnAuto").onclick=()=>{
  autoOn=!autoOn; autoState.textContent=autoOn?"ON":"OFF";
  log(autoOn?"ğŸ¤– Auto-On ativado":"âŒ Auto-On desativado","sys");
  if(autoOn) play("snd-green"); else play("snd-red");
};

/* ===== BroadcastChannel + postMessage ===== */
const bc = new BroadcastChannel("matrix-channel");
bc.onmessage = ev => { log("ğŸ“¡ Broadcast: "+JSON.stringify(ev.data),"sys"); handleIncoming(ev.data); };
$("#btnPing").onclick=()=>{ bc.postMessage({type:"ping", at:Date.now()}); log("ğŸ“¡ Enviado broadcast ping","sys"); };
window.addEventListener("message", ev=>{ if(ev.data?.type==="matrix"){ log("ğŸ’¬ postMessage: "+JSON.stringify(ev.data.payload),"sys"); handleIncoming(ev.data.payload);} });

/* ===== WS Manager (com mÃ¡scara/sanitizaÃ§Ã£o) ===== */
let ws=null, masked=false;
function sanitizeWsUrl(u){ try{ const url=new URL(u); ["EVOSESSIONID","JSESSIONID","videoToken","token","auth","session","videoSessionId","client_version"].forEach(k=>url.searchParams.delete(k)); return url.origin+url.pathname+(url.search?`?${url.searchParams.toString()}`:""); } catch(_){ return (u||"").replace(/(EVOSESSIONID|JSESSIONID|videoToken|token)=([^&]+)/gi,"$1=â€¢â€¢â€¢"); } }
function setConnUI(connected){ $("#btnConnect").disabled=connected; $("#btnDisconnect").disabled=!connected; elWS.textContent=connected?"online":"offline"; }
$("#btnMask").onclick=()=>{ masked=!masked; const el=$("#apiUrl"); if(masked){ el.dataset.real=el.value; if(el.value){ try{const u=new URL(el.value); el.value=`${u.protocol}//${u.host}/â€¢â€¢â€¢`;}catch(_){el.value="â€¢â€¢â€¢"} } } else { if(el.dataset.real) el.value=el.dataset.real; } };
$("#btnCopy").onclick=()=>{ const el=$("#apiUrl"); const v=(masked && el.dataset.real)?el.dataset.real:el.value; navigator.clipboard.writeText(v||"").then(()=>log("URL copiada","sys")) };

$("#btnConnect").onclick=()=>{
  const raw=($("#apiUrl").dataset.real||$("#apiUrl").value||"").trim();
  if(!raw){ log("Cole a URL do WebSocket/API.","warn"); return; }
  const safe=sanitizeWsUrl(raw);
  try{
    ws=new WebSocket(raw);
    ws.onopen=()=>{ setConnUI(true); log("âœ… Conectado: "+safe,"sys"); };
    ws.onclose=()=>{ setConnUI(false); log("âŒ Desconectado","warn"); };
    ws.onerror=e=>log("âš ï¸ Erro WS: "+(e?.message||"desconhecido"),"warn");
    ws.onmessage=ev=>{ let data=ev.data; try{ data=JSON.parse(ev.data);}catch(_){ } handleIncoming(data); };
  }catch(e){ log("âš ï¸ Falha ao abrir WS: "+e.message,"warn"); }
};
$("#btnDisconnect").onclick=()=>{ if(ws){ try{ws.close()}catch(_){}} ws=null; setConnUI(false); log("ğŸ”Œ ConexÃ£o encerrada","warn"); };

/* ===== Handler de mensagens (Evolution/Pragmatic/GenÃ©rico/BC/PM) ===== */
let lastNum=null, lastAt=0;
function handleIncoming(payload){
  // entradas nÃ£o processam nÃºmero
  if(payload?.type==="entries"){ return; }

  let n=null, platform=activePlatform;
  if(payload?.type==="roulette.winSpots"){ n=payload?.args?.result?.[0]?.number ?? null; platform="Evolution"; }
  if(n==null && (payload?.type==="spin_result" || payload?.type==="result" || payload?.winningNumber!=null)){ n=payload?.result ?? payload?.winningNumber ?? null; platform="Pragmatic"; }
  if(n==null && typeof payload?.number==="number"){ n=payload.number; }

  if(typeof n!=="number" || n<0 || n>36){
    log("Msg recebida (sem nÂº vÃ¡lido): "+(typeof payload==="string"?payload:JSON.stringify(payload)),"sys");
    return;
  }

  const now=performance.now();
  if(lastNum===n && (now-lastAt)<1200){ log(`(dedupe) nÂº ${n} ignorado`, "sys"); return; }
  lastNum=n; lastAt=now;

  $("#last").textContent=String(n);
  pushNumber(n);
  const col=colorOf(n);
  log(`ğŸ¯ NÂº: ${n} (${col}) â€¢ ${platform}`,"hit");
  play("snd-green");

  if(running){
    const align=0.25; const rem=(nextBeat-now)/1000;
    if(rem<align || rem>cadence-align){ nextBeat=now+cadence*1000; log("â›­ Resincronizado (evento)","sys"); }
  }
}

/* ===== Simular / Limpar / Export CSV ===== */
$("#btnSim").onclick=()=>{ const v=parseInt($("#simNumber").value,10); if(Number.isFinite(v)&&v>=0&&v<=36){ handleIncoming({number:v, source:"sim"}); } else { log("Informe 0â€“36","warn"); play("snd-red"); } };
$("#btnClearNums").onclick=()=>{ recent=[]; renderChips(); log("ğŸ§¹ Ãšltimos nÃºmeros limpos","sys"); };
function exportCSV(){ const header="timestamp,numero\n"; const now=new Date().toISOString(); const rows=recent.map(n=>`${now},${n}`).join("\n"); const csv=header+rows+"\n"; const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"})); a.download="matrix_last_numbers.csv"; a.click(); URL.revokeObjectURL(a.href); }
$("#btnExportCsv").onclick=exportCSV;

/* ===== Auto-On inicial ===== */
let autoOn=false; // definido acima; re-usa variÃ¡vel
/* jÃ¡ controlado pelos botÃµes */

/* ===== Init ===== */
(function init(){ $("#cadence").textContent=`${cadence}s`; })();
</script>
</body>
</html>
